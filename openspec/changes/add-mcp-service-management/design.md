## Context

本设计文档描述 MCP (Model Context Protocol) 服务管理模块的技术架构。MCP 是 Anthropic 开发的开放协议，用于连接 AI 应用与外部工具和数据源。

### 背景

- Wenko 系统目前支持 LLM 对话功能，但缺乏与外部工具的集成能力
- MCP 提供了标准化的方式来扩展 AI 的能力（工具调用、资源访问等）
- 需要一个管理模块来处理多个 MCP 服务器的生命周期

### 约束

- 必须与现有的设置管理系统保持一致的模式
- UI 需要融入现有的 Workflow 面板风格（shadcn/ui 组件）
- 服务进程管理需要考虑跨平台兼容性（macOS、Windows）

## Goals / Non-Goals

### Goals
1. 用户可以注册多个 MCP 服务器（支持 stdio 传输方式）
2. 用户可以通过 UI 启动、停止、删除已注册的服务
3. 系统显示每个服务的实时状态（运行中/已停止/错误）
4. 服务配置持久化存储在 SQLite 数据库中
5. 提供 REST API 供程序化管理

### Non-Goals
1. 暂不实现 MCP 工具调用与对话系统的集成（后续迭代）
2. 暂不支持 SSE 传输方式（优先支持 stdio）
3. 暂不实现服务自动重启/故障恢复
4. 暂不支持 MCP 服务器的远程连接（仅支持本地进程）

## Decisions

### 1. 数据存储方案

**决策**: 使用现有的 `app_settings` 表存储 MCP 服务配置，采用 JSON 格式存储服务列表。

**替代方案考虑**:
- 新建独立的 `mcp_servers` 表 - 更规范但增加复杂度
- 使用文件配置 (JSON/YAML) - 不符合项目现有的数据库优先模式

**理由**: 与现有设置系统保持一致，减少数据库 schema 变更，简化实现。

**数据结构**:
```json
{
  "mcp.servers": [
    {
      "id": "uuid-string",
      "name": "文件系统服务",
      "command": "uvx",
      "args": ["mcp-server-filesystem", "/path/to/allowed"],
      "env": {"KEY": "value"},
      "enabled": true,
      "created_at": "2024-01-30T10:00:00Z"
    }
  ]
}
```

### 2. 服务进程管理

**决策**: 使用 Python `subprocess` 模块管理 MCP 服务器进程。

**架构**:
```
┌─────────────────────────────────────────────────┐
│                  MCP Manager                    │
│  ┌───────────────────────────────────────────┐  │
│  │          MCPServerRegistry                │  │
│  │  - servers: Dict[str, MCPServerConfig]    │  │
│  │  - load_from_db()                         │  │
│  │  - save_to_db()                           │  │
│  └───────────────────────────────────────────┘  │
│                       │                         │
│  ┌───────────────────────────────────────────┐  │
│  │          MCPProcessManager                │  │
│  │  - processes: Dict[str, subprocess.Popen] │  │
│  │  - start_server(id)                       │  │
│  │  - stop_server(id)                        │  │
│  │  - get_status(id)                         │  │
│  └───────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```

**进程状态管理**:
- `stopped` - 进程未运行
- `running` - 进程正常运行中
- `error` - 进程启动失败或异常退出

### 3. API 设计

**决策**: RESTful API，遵循现有 `/api/*` 路由模式。

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/mcp/servers` | GET | 获取所有服务列表及状态 |
| `/api/mcp/servers` | POST | 注册新服务 |
| `/api/mcp/servers/{id}` | GET | 获取单个服务详情 |
| `/api/mcp/servers/{id}` | PUT | 更新服务配置 |
| `/api/mcp/servers/{id}` | DELETE | 删除服务 |
| `/api/mcp/servers/{id}/start` | POST | 启动服务 |
| `/api/mcp/servers/{id}/stop` | POST | 停止服务 |
| `/api/mcp/servers/{id}/restart` | POST | 重启服务 |

### 4. 前端状态管理

**决策**: 创建独立的 `use-mcp-services.ts` Hook，采用轮询方式获取服务状态。

**替代方案考虑**:
- WebSocket 实时推送 - 增加复杂度，目前需求不迫切
- SSE 事件流 - 项目已有 SSE 基础设施，但服务状态更新频率低

**理由**: 轮询模式简单可靠，适合服务状态这种低频更新场景。设置 5 秒轮询间隔。

### 5. UI 组件设计

**决策**: 在 Workflow 面板添加新的 "MCP 服务" 标签页。

**界面布局**:
```
┌────────────────────────────────────────────────────┐
│  聊天历史 │ 工作记忆 │ 长期记忆 │ MCP服务 │ 设置 │
├────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────┐   │
│  │  [+ 添加服务]                     刷新 状态 │   │
│  └─────────────────────────────────────────────┘   │
│                                                    │
│  ┌─────────────────────────────────────────────┐   │
│  │ 📁 文件系统服务                     ● 运行中 │   │
│  │    uvx mcp-server-filesystem               │   │
│  │    [停止] [编辑] [删除]                     │   │
│  └─────────────────────────────────────────────┘   │
│                                                    │
│  ┌─────────────────────────────────────────────┐   │
│  │ 🔍 搜索服务                         ○ 已停止 │   │
│  │    npx @anthropic/mcp-server-brave-search   │   │
│  │    [启动] [编辑] [删除]                     │   │
│  └─────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
```

## Risks / Trade-offs

### 风险 1: 进程管理的平台差异
- **风险**: Windows 和 macOS/Linux 的进程管理行为可能不同
- **缓解**: 使用 Python 标准库 `subprocess`，避免平台特定的 API

### 风险 2: 服务进程泄漏
- **风险**: 应用异常退出时可能留下孤儿进程
- **缓解**:
  - 在 FastAPI 的 shutdown 事件中清理所有子进程
  - 使用进程组管理（Unix）或 Job Objects（Windows）

### 风险 3: 配置数据一致性
- **风险**: 服务配置存储为 JSON，可能存在并发写入问题
- **缓解**: 使用数据库事务保证原子性更新

### Trade-offs

| 选择 | 优势 | 劣势 |
|------|------|------|
| JSON 存储 vs 独立表 | 实现简单，无 schema 迁移 | 查询不灵活，数据验证弱 |
| 轮询 vs WebSocket | 简单可靠，无状态 | 实时性稍差（5秒延迟） |
| stdio vs SSE | MCP SDK 原生支持好 | 限于本地进程 |

## Migration Plan

此为新功能，无需数据迁移。

### 部署步骤
1. 部署后端更新（包含新的 API 端点）
2. 部署前端更新（包含 MCP 管理 UI）
3. 数据库会自动初始化 `mcp.servers` 设置项（空数组）

### 回滚计划
- 如需回滚，移除前端 MCP Tab 即可
- 后端 API 可保留，不影响现有功能

## Open Questions

1. **是否需要支持服务器模板/预设？**
   - 如常用的 `mcp-server-filesystem`、`mcp-server-brave-search` 等
   - 可在后续迭代中添加

2. **服务日志如何展示？**
   - 当前设计未包含日志查看功能
   - 可考虑在服务卡片中添加 "查看日志" 功能

3. **MCP 工具调用如何与对话系统集成？**
   - 这是后续工作，当前提案仅关注服务管理
