# Design: Enhanced HITL Continuation Response

## Context

当前 HITL continuation 系统在用户提交表单后调用 LLM 继续对话，但提示词没有明确要求 AI 根据用户输入提供详尽的、有针对性的响应。问题的根源是：

1. `build_continuation_context` 只是简单地列出用户填写的数据，最后以"请根据用户的选择继续对话"结尾
2. `HITL_CONTINUATION_PROMPT_TEMPLATE` 没有强调响应质量和深度要求
3. 缺乏对表单复杂度的识别，无法根据用户投入的努力调整响应深度

### 相关代码

- `workflow/hitl_handler.py:555-591` - `build_continuation_context()` 函数
- `workflow/chat_processor.py:794-820` - `HITL_CONTINUATION_PROMPT_TEMPLATE`

## Goals / Non-Goals

### Goals
- 用户提交复杂表单后，AI 提供详尽、有实质价值的响应
- 响应应包含具体建议、分析、或行动方案
- 响应深度与用户输入的复杂度成正比
- 保持 JSON 输出格式不变

### Non-Goals
- 不改变 HITL 表单的 schema 结构
- 不改变 continuation API 接口
- 不实现外部数据获取（如实时查询旅游信息）

## Decisions

### Decision 1: 增强上下文指令 vs 修改系统提示词

**选择**: 同时增强两者

**原因**:
- `build_continuation_context` 负责描述用户输入，应该增加响应期望指引
- `HITL_CONTINUATION_PROMPT_TEMPLATE` 负责整体角色设定，应该强调响应质量

### Decision 2: 表单复杂度评估方式

**选择**: 基于字段数量和内容长度的简单启发式评估

**评估逻辑**:
- 字段数量 >= 5 或总内容长度 >= 200 字符 → 高复杂度
- 字段数量 >= 3 或总内容长度 >= 100 字符 → 中复杂度
- 其他 → 低复杂度

**原因**:
- 简单实用，无需复杂 NLP 分析
- 字段数量反映用户投入的时间
- 内容长度反映用户提供的信息深度

### Decision 3: 响应质量指导原则

**选择**: 在上下文中注入具体的响应要求

**高复杂度表单的响应要求**:
```
请根据用户提供的详细信息，给出全面、深入的响应：
1. 分析用户的需求和偏好
2. 提供具体、可操作的建议（至少3-5条）
3. 如适用，给出分步骤的计划或方案
4. 根据用户的约束条件（预算、时间等）调整建议
5. 主动补充用户可能没想到但有价值的信息
```

**中复杂度表单的响应要求**:
```
请根据用户的输入提供有价值的响应：
1. 确认理解用户的需求
2. 提供2-3条具体建议
3. 如有疑问，可以追问细节
```

**低复杂度表单的响应要求**:
```
请简洁地回应用户的选择，并询问是否需要进一步帮助。
```

## Risks / Trade-offs

### Risk 1: 响应过长
- **风险**: 高复杂度表单可能导致响应过于冗长
- **缓解**: 在提示词中加入"简洁但全面"的要求，控制响应长度在合理范围

### Risk 2: LLM token 消耗增加
- **风险**: 更详细的提示词和更长的响应会增加 API 成本
- **缓解**: 仅对高复杂度表单使用详尽提示词，低复杂度保持简洁

### Risk 3: 响应质量依赖 LLM 能力
- **风险**: 不同 LLM 对指令的遵循程度不同
- **缓解**: 使用明确、结构化的指令，在多个模型上测试

## Migration Plan

无需迁移，新功能向后兼容。

## Resolved Questions

1. **是否需要在 UI 中展示"AI 正在分析您的信息..."的加载提示？**
   - **决定**: 是。需要实现加载提示以设定用户对详细响应的预期
   - **原因**: 复杂表单的处理需要更长时间，加载提示可以：
     - 让用户知道系统正在认真处理他们的输入
     - 设定对详细响应的心理预期
     - 避免用户因等待时间较长而感到焦虑
